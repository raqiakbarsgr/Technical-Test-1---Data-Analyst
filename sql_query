with filtered as (SELECT 
  td.client_id,
  EXTRACT(HOUR FROM DATETIME(td.date, "Asia/Jakarta")) AS hour,
  EXTRACT(DATE FROM DATETIME(td.date, "Asia/Jakarta")) AS date,
  cd.card_brand,
  cd.card_type,
  cd.card_number,
  cd.acct_open_date,
  ud.gender,
  ud.retirement_age,
  current_age,
  ud.per_capita_income,
  td.amount,
  COUNT(DISTINCT td.client_id) AS total_unique_user,
  ROW_NUMBER() OVER (Partition by td.client_id,card_brand,card_type,card_number,cd.acct_open_date) as rn
FROM `data_analyst_application.transaction_data` td
LEFT JOIN `data_analyst_application.cards_data` cd 
  ON cd.client_id = td.client_id
LEFT JOIN `data_analyst_application.users_data` ud 
  ON ud.id = td.client_id
WHERE merchant_state LIKE '%Indonesia%'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12)

select * except(rn,amount,hour,date),avg(amount), max(rn) as repeat_transaction from filtered
GROUP BY 1,2,3,4,5,6,7,8,9,10
order by 12 desc
